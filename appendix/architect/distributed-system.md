#### 分布式系统的误区

- 网络是安全的
- 延迟是不存在
- 带宽是用之不尽的
- 网络是安全的
- 拓扑结构是不变的
- 拓扑结构是不变的
- 一个管理员可以搞定一切
- 传输是没有成本
- 络通信都是一样的

#### 微服务架构的优势

- 敏捷性
- 持续创新
- 渐进式设计
- 小而专的团队
- 故障隔离
- 更好的扩容和资源利用能力
- 改善可观察性

#### 微服务架构带来的挑战

- 复杂性
- 数据完整性和一致性
- 性能
- 开发和测试
- 版本控制和集成
- 监控和日志管理
- 服务依赖管理
- 可用性

#### 无论你选择哪个云服务提供商，你都应该记住这五个支柱。
1. 精益运营
    - 全自动化
    - 监控一切
    - 完善文档
    - 增量更改
    - 为故障而设计
2. 安全性
   - 容器化服务(基于Kubernetes)的纵深防御列表
      1. 源代码
      2. 容器镜像
      3. 容器注册服务器
      4. pod
      5. 集群和编排工具
3. 可靠性和可用性
   - 可靠性是当故障发生了，应用程序仍然处于一个可接受的工作状态。
   - 可用性指的是你的应用程序在一个时间窗口内可以正常提供服务的时间。
4. 可扩展性与成本

#### 云原生应用的数据处理的特征

- 倾向使用托管数据存储和处理服务。
- 使用混合持久化、数据分区和缓存。
- 倾向使用最终一致性，只在必要时使用强一致性。
- 优先选择具有可扩展性、容错性且针对云存储进行了优化的云原生数据库。
- 处理分布在多个数据存储中的数据

#### CAP定理

提到分布式系统就不得不提一下CAP定理。CAP定理指出，任何一个通过网络连接的、共享数据的分布式系统最多只能同时满足以下三个需求中的两个：
- 一致性（Consistency，C）：指所有节点访问同一份最新的数据副本。
- 可用性（Availability，A）：指系统提供的数据或服务必须一直处于可用状态。
- 分区容错性（Partition tolerance，P）：指系统在遇到网络分区故障的时候，仍然能够对外提供服务。
现实情况是，网络分区故障经常会出现（记得前面所提到的，“网络是安全的”是分布式系统的误区之一），所以你必须考虑到这一点。然而这样的话你就不得不在追求一致性还是高可用性之间做出取舍。很多NoSQL数据库（如Cassandra）会选择追求高可用性，而像关系型数据库会为了遵循ACID原则（原子性、一致性、隔离性和持久性）而追求一致性。

#### 十二要素应用

在基础架构即服务（Infrastructure as a Service，IaaS）和平台即服务（Platform as a Service，PaaS）发展的早期阶段，人们就发现需要一种新的方式来开发更适用于云计算的应用程序。举个例子，传统数据中心在需要扩容时经常采用纵向扩容的方式，即通过增加单台物理服务器的计算资源来进行扩容。而在云端，通常采用的是横向扩容的方式，即通过增加虚拟服务器的数量来分担负载。这种扩容方式要求应用程序是无状态的，而这个特点也是十二要素（12-factor）应用的宣言之一。十二要素应用这一方法论是由Heroku的工程师从云端应用开发的最佳实践中总结出来的，可以被认为是云原生应用的基础。尽管云计算一直在不停地发展，但是十二要素宣言中的这些原则仍然适用。以下是十二要素的内容及其对于云原生应用的意义：

1. 基准代码
一份基准代码，多份部署。
一个应用只有一份基准代码，但是这份代码可以部署到多个环境中，如开发环境、测试环境和生产环境。在云原生架构中，这个原则可以解释成一个服务或者函数只有一份基准代码，它们各自拥有自己的持续集成（Continuous Integration，CI）和持续部署（Continuous Deployment，CD）工作流。

2. 依赖
显式地声明依赖关系并隔离依赖。
声明和隔离依赖在云原生应用的开发中很重要。很多问题是由缺少依赖项或依赖项的版本不同造成的，其根源在于内部部署环境和云端环境是有差异的。通常，你应该用类似Maven或npm这样针对不同语言的管理工具来管理依赖项。现在，容器技术已经大大减少了由依赖产生的问题，因为依赖项都会在Dockerfile中进行声明然后被打包进容器中。对系统依赖而言，Chef、Puppet、Ansible和Terraform是很好的管理和安装工具。

3. 配置
在环境中存储配置。
配置和代码应该严格分开，这样你才能够轻松地配置不同的环境。例如，在测试环境中，你可以有一个测试配置文件，这个文件中包含的连接字符串和其他信息都是指向这个测试环境的。如果你想把这个应用部署到生产环境中，那么你只需要替换掉这个配置文件就可以了。现在很多平台都支持外部配置，比如使用Kubernetes的配置管理或者使用云端环境中的托管配置服务。

4. 后端服务
把后端服务当作附加资源。
后端服务指的是程序运行所需要的通过网络调用的各种服务。举两个在云原生应用领域的例子，比如像缓存服务和数据库服务（Database as a Service，DbaaS），这些都是后端服务。在访问这些后端服务时，一个比较推荐的做法是通过外部配置系统来获取这些服务的配置信息。这样做的好处是降低耦合度，这也是云原生应用的一个基本原则。

5. 构建、发布和运行
严格分离构建和运行阶段。
正如你将在第5章中看到的DevOps相关内容，建议使用CI/CD的一些实践来实现全自动地构建和发布应用。

6. 进程
用一个或多个无状态的进程来运行应用。
如前所述，在云端的应用应该是无状态的，任何需要持久化的数据都应该存储在外部。这样做才能实现弹性，而弹性是云计算的目的之一。

7. 数据隔离
每个服务管理自己的数据。
这是微服务架构的一个关键原则，同时也是云原生应用的一个常见模式。每个服务管理自己的数据，这些数据只有通过该服务的API才能获取。这意味着即使属于同一个应用，一个服务也无法直接访问其他服务中的数据。

8. 并发
通过进程模型进行扩展。
云原生应用的两大优势是可扩展性和更有效的资源利用。你可以通过独立横向扩展单个服务或者函数来实现更高的资源利用率。

1. 易处理
通过快速启动和优雅退出来最大化应用的健壮性。
容器技术和函数已经能够满足第一点了，因为它们的启动速度都很快。但后一点常常被忽略，在设计一个服务时就应该考虑到程序崩溃和规模收缩问题，这种情况下容器或者函数的实例数量会减少，我们要特别注意这一点。

10. 开发环境与线上环境等价
尽可能地保持开发环境、预发布环境和生产环境相同。
你可以利用容器技术来打包服务所需的依赖项，这样可以减少环境的不一致带来的问题。但还是会有一些比较棘手的情况，比如在你的开发环境下，有些受托管的服务是不可用的。第5章会介绍一些技术和方法来使得你的环境尽量保持一致。

11. 日志
把日志当作事件流。
在分布式系统中，记录日志是一件很重要的事。因为有那么多的服务在同时运行，又是跑在不同的节点上的，如果你没有一个很好办法来记录日志，一旦你的应用出问题了，那你就抓瞎了。十二要素的这一条就是告诉你可以把日志当作事件流来处理，把这些事件流输出到一个外部系统中统一记录。

12. 管理进程
把后台管理任务当作一次性进程来运行。
这一点的意思是你应该把管理任务当作是一个短期进程来执行。函数和容器都是执行这些任务的好工具。
你会在本书中再次了解上述要素，因为它们与云原生应用息息相关。

#### 数据存储的选择

在选择数据产品前应该尽可能收集的需求信息。

##### 功能性需求
- 数据格式: 你需要存储的是什么类型的数据？
- 读和写: 数据是如何被写入和使用的？
- 数据大小: 保存在数据存储中的数据记录有多大？
- 伸缩性和结构: 你需要多少存储空间？预期是否需要对数据做分区？
- 数据间的关系: 你的数据是否需要支持复杂的关系？
- 一致性模型: 你需要强一致性还是可以接受最终一致性？
- 模式是否灵活: 你的数据需要什么样的数据模式（结构）？这个模式是强约束的还是可以灵活变化？
- 并发: 你的应用将从多版本并发控制中受益吗？你是否需要悲观和/或乐观锁来控制并发？
- 数据迁移: 你的应用需要将数据迁移到别的数据存储或者数据仓库吗？
- 数据的生命周期: 数据是一次写入，多次读取吗？可以随着时间的推移进行归档吗？还是可以通过下采样来降低数据的保真度？
- 数据更改: 是否需要支持数据更改捕获（Change Data Capture，CDC）并在数据更改时触发事件？
- 其他功能: 是否需要任何其他特定功能，如全文检索、索引编制等？

##### 非功能性需求
- 团队经验: 选择某个特定数据库的最大原因之一或许是因为团队对这个数据库有经验。
- 技术支持: 有时，技术上最适合应用程序需求的数据库并不一定是最适合项目的。因为还需要考虑该产品的技术支持是否满足组织的需求。
- 性能和可扩展性: 你的应用程序的性能需求是怎样的？是写数据的负载大还是查询和分析的任务更多？
- 可靠性: 你的应用程序对可用性有什么需求？需要哪些备份和故障恢复功能？
- 备份: 数据需要在多个地域或者可用区备份吗？
- 限制项: 在大小和规模上是否有硬性限制？
- 可移植性: 你需要将其部署在本地还是要部署到多个云服务商的环境中？

##### 管理和成本
- 托管服务: 如果可能，尽量使用托管的数据服务。尽管某些情况下有些功能不存在或者不需要。
- 可用区或云服务商的可用性: 应用所在的地方是否有托管数据存储解决方案？
- 许可证: 你所在的企业是否对使用何种许可证类型有限制？你偏爱商业软件许可证还是开源软件（OSS）许可证？
- 综合成本: 在你的解决方案中使用该服务的综合成本是多少？选择托管服务的一个重要理由是它降低了运营成本。


#### 捕获数据更改（CDC）的一些常见用例包括

- 通知: 在微服务架构中，常常会遇到一个服务希望收到另一个服务中数据更改的通知的情况。为此，你可以使用Webhook或订阅来发布事件通知给其他服务。
- 实例化视图: 实例化视图提供了在系统上进行有效且简化的查询的能力。更改事件可用于更新这些视图。
- 缓存失效: 缓存对于提高系统的扩展性和性能非常有用，但是当后端数据发生更改时如何使缓存中的数据无效是个挑战。除了使用有效时间（Time-To-Live，TTL）外，你还可以使用更改事件来删除或更新缓存中的数据。
- 审计: 许多系统有维护数据更改记录的需求。你可以使用更改的日志来跟踪更改的内容和时间。我们也经常需要知道是谁进行了更改，因此有必要把这个信息也记录下来。
- 搜索: 许多数据库不能很好地处理搜索，而搜索数据库又不能提供其他数据库所具备的所有功能。你可以使用变更数据流来维护搜索索引。
- 数据分析: 企业的数据分析需求通常需要跨越许多不同数据库组成数据视图。将数据发送至中央数据湖、数据仓库或数据库可以实现更丰富的报告和分析需求。
- 变更分析: 可以把对变更数据的近实时分析与数据访问问题分割开来，从而专注对数据更改进行分析。
- 归档: 在一些应用中，可能会有对当前状态进行归档的需求。这个归档数据很少被访问到，因此它更适合存储在成本较低的存储系统中。
- 历史遗留系统: 替换一个历史遗留系统有时会要求把数据存放到多个存储中。数据更改的数据流可以用来更新遗留系统中的数据。

#### 客户端访问数据
> 一个简单地以数据为中心的应用程序通常需要你构建和运行一个服务，该服务执行数据的鉴权、授权、日志记录、转换和验证。它需要控制哪些人可以访问数据存储中的内容以及验证所写的内容。

- 受限的客户令牌（代客密钥）
- 细粒度访问控制的数据库服务
- GraphQL数据服务

#### 日志
> 日志是很关键的一个部分，它可以帮助你提高服务和函数的可观测性。以下是在开发服务和函数时你需要记住的几点：
- 使用结构化的日志以方便其他工具或自动化脚本解析它。
- 日志记录应当容易阅读，清晰明了，能提供有价值的信息。
- 日志中所有的时间都应该在同一个时区下，用同一个时间格式。
- 对日志分类：debug、info和error是常见的几种日志类型。
- 永远不要记录私有的或敏感的信息（密码、连接字符串等）。如果你无法避免记录这些，那一定要确保它们已经经过清洗。