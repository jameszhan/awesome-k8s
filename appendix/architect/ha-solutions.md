#### 在设计网站的系统架构之前，应该从以下方面考虑如何选购服务器：

- 服务器要运行什么应用。
- 需要支持多少用户访问。
- 需要多大空间来存储数据。
- 业务有多重要。
- 服务器网卡方面的考虑。
- 安全方面的考虑。
- 机架安排是否合理化。
- 服务器的价格是否超出了预算。

#### 缓存服务器

- `Varnish`
- `Redis`

#### 负载均衡器
- `F5 BIG-IP`
- `Citrix NetScaler`
- `LVS`
- `Nginx`
- `HAProxy`
- `AWS ELB`

#### 高可用软件
- `Heartbeat`
- `Keepalived`

#### Linux集群架构
- `DNS轮询`
- `LVS+Keepalived`
- `Nginx/HAproxy`+`Keeaplived`
- `DRBD`+`Heartbeat`

> `DRBD`: 分布式块设备复制(`Distributed Replicated Block Device`，`DRBD`)，是一种基于软件的、基于网络的块复制存储解决方案，主要用于对服务器之间的磁盘、分区、逻辑卷等进行数据镜像。当用户将数据写入本地磁盘时，还会将数据发送到网络中另一台主机的磁盘上，这样本地主机(主节点)与远程主机(备节点)的数据就可以保证实时同步，当本地主机出现问题，远程主机上还保留着一份相同的数据，可以继续使用，保证了数据的安全。

#### Linux集群的总结和思考

01. 目前网站架构一般分为负载均衡层、Web层和数据库层，笔者一般还会多加一层，即文件服务器层，因为随着网站的流量越来越多，文件服务器的压力也越来越大，如果觉得DRBD+Heartbeat+NFS架构在后期压力太大，可以考虑图片单独分离，或者在前端采用CDN的方式来解缓海量图片的压力。网站最前端的负载均衡层称为Director，它起分摊请求的作用，最常见的就是轮询，这是每一台负载均衡器都自带的基本功能。
02. F5是通过硬件的方式实现负载均衡的，在CDN系统上使用较多，用于Squid/Varnish反向加速集群的负载均衡，是专业的硬件负载均衡设备，适合每秒新建连接数和并发连接数要求高的场景。LVS和HAProxy是通过软件的方式实现的，但其稳定性也相当强悍，在处理高并发的情况时有着相当不俗的表现。至于Nginx，笔者比较倾向于将其放在整个系统或网站的中间层，让其作为中间层的负载均衡器，这样效果更好。
03. Nginx对网络的依赖较小，理论上只要ping得通，网页访问正常，Nginx就能连得通。Nginx还能区分内外网，如果是同时拥有内外网的节点，就相当于单机拥有了备份线路。LVS则比较依赖于网络环境，如果采用的是LVS/DR模式，利用LVS分流的服务器都必须在同一机房的同一交换机上，有时不得不考虑单交换机带来的单点故障问题。
04. 集群是指负载均衡后面的Apache集群或Tomcat集群等，但有时候大家所谈论的Linux集群却泛指了整个系统架构，既包括了负载均衡器，也包括了后端的应用服务器集群等。其实可以这样来加以区分，如果专指小范围的集群概念，可以指Web集群、Squid集群等，如果指广泛意义上的集群，我们可以接受Linux集群这种叫法，这样大家就不至于在概念上混淆了。
05. 负载均衡高可用中的“高可用”指的是实现负载均衡器的HA，即一台负载均衡器坏掉后另一台可以在小于1秒的时间内切换，最常用的软件就是Keepalived和Heartbeat。在成熟的生产环境下负载均衡器方案有LVS+Keepalived/Heartbeat、Nginx+Keepalived。如果能保证Heartbeat的心跳线稳定，Heartbeat+DRBD也可应用于成熟的生产环境下，适合NFS文件服务器或MySQL的高可用环境。
06. LVS的优势非常多，如抗负载能力强、工作稳定性高（因为有成熟的HA方案）、无流量的转发、效率高、基本支持所有的TCP应用（当然包括Web）等。基于上述优点，LVS拥有不少的粉丝，但它也有缺点，对网络的依赖性太大了。在网络环境相对复杂的应用场景中，我们不得不放弃它而选用HAProxy或Nginx。
07. Nginx对网络的依赖性小，而且它的正则表达式强大且灵活（个人觉得比HAProxy简单），其稳定的特点吸引了不少人，而且配置起来也相当方便和简约，在中小型项目的实施过程中基本都会考虑用它。另外，Nginx+Lua不仅能作为Web级别的防火墙，还能搞定业务中许多复杂的需求。
08. 在大型网站架构中其实可以结合使用F5/LVS或Nginx，根据情况选择其中的两种或全部选择。如果因为预算而不能选择F5的话，那么网站最前端的指向应该是LVS，也就是DNS的指向应为LVS均衡器，LVS的优点令它非常适合这个任务。那些重要的IP地址，最好交由LVS托管，比如数据库的IP、提供Web服务的IP等，随着时间的推移，这些IP地址的使用面会越来越大。如果更换IP则故障会接踵而至，所以将这些重要IP交给LVS托管是最为稳妥的。
09. 在实际项目实施过程中，我们发现HAProxy和Nginx对HTTPS的支持都非常好，尤其是Nginx，相对而言处理起来更为简便。至于HAPoryx的ACL规则，这也是一个仁者见仁，智者见智的问题，依照个人的习惯进行选择，跟Nginx的rewrite有很多功能上的重复，大家二选一即可。
10. 如果是基于LVS+Keepalived及Nginx+Keepalived架构的Web网站发生故障时，处理起来是很方便的。如果发生了系统故障或服务器相关故障，可以将DNS指向后端的某台真实Web机器上，达到短期处理故障的目的。对于广告网站和电子商务网站来说，流量就是业务，流量就是金钱，所以如果电子商务网站出了问题，还是得尽可能在最短的时间内修复故障。
11. 之前Linux集群都被大家夸大化了，其实它并不是很复杂，关键看个人的应用场景，哪种适合就选用哪种。Nginx、HAProxy、LVS和F5都不是万能的，都有自身的缺陷，我们应该扬长避短，最大限度地发挥它们的优势。
12. 另外关于Session共享的问题（这也是一个老生常谈的问题了），Nginx可以用ip_hash机制解决，HAProxy可以用balancesource解决，而LVS则可以用会话保持机制来解决。此外，还可以将Session写进NoSQL数据库（例如memcached或redis），这也是一个解决Session共享的好办法。
13. 现在很多朋友都用Nginx（尤其是作为Web服务器），其实在服务器性能优异且内存足够的情况下，Apache的抗并发能力并不弱（16GB的内存下Apache过2000并发问题也不大，当然，配置文件也要优化），整个网站的瓶颈应该还是在数据库方面，建议大家全面了解Apache和Nginx。前端可以用Nginx作负载均衡器，后端用Apache集群作Web应用服务器，这样升级以前的Apache集群版本时可以采用切量的方式，达到平滑升级的目的，这样给网站带来的影响也是最小的。
14. Heartbeat的“脑裂”问题没有想象中的那么严重，可以考虑在线上环境下使用。DRDB+Heartbeat算是成熟的应用了，建议大家掌握这个知识热点。笔者曾在相当多的场合中使用此组合替代EMC共享存储，毕竟并不是每个人都能够接受商业存储的价格。
15. 无论设计的方案多么成熟，还是建议配置Nagios/Zabbix监控机制来实时监控服务器的情况。建议邮件和短信报警全都开启，毕竟手机可以随身携带。有条件的话还可以购买专门的商业扫描网站服务，例如Alertbot，它会以1秒为频率扫描你的网站，如果发现网站有宕机的情况，立即向你的邮箱中发送警告邮件。
16. 关于网站的安全性问题，建议大家使用硬件防火墙，比较推荐的是华赛或Juniper系列的防火墙，DDoS的安全防护一定要到位（国内的DDoS攻击还是挺多的，硬件防火墙能在一定程度上帮忙防御部分流量攻击）。实在没有硬件防火墙的环境，建议应用服务器开启Linux服务器本身的iptables防火墙，很多对外的API一定要限制公网IP地址访问。另外，为了安全起见，服务器的应用还是开启得越少越好，这样端口数量也开放的更少。

#### 诊断工具：`top`、`ps`、`netstat`和`iostat`

- `top`: 查看（虚拟）机器上运行的所有进程。
- `ps`: 列出（虚拟）机器上运行的所有进程。
- `netstat`: 查看（虚拟）机器上所有的网络连接。
- `iostat`: 列出连接到（虚拟）机器的所有块设备（磁盘驱动）的`I/O`统计。
- `dig` `or` `nslookup`: 提供`DNS`地址信息。
- `ping`: 检查是否可以通过网络访问某个`IP`或者域名。
- `tracert`: 跟踪网络中（包括内网和`Internet`）某个`IP`包的路由。
- `tcpdump`: 对`TCP`网络流量进行嗅探。这是一个高级工具，但是在云环境中非常有用，因为云环境中的大部分通信都是基于`TCP`的。
- `strace`: 跟踪系统调用。这是一个高级工具，但是在调试容器或安全问题时非常有用。
- [`sysdig`](https://www.sysdig.org/install/): 一个有用的容器感知诊断工具。
- [`systemd-cgtop`](http://bit.ly/2xFaFaX): 一个systemd工具，以类似top的方式来查看cgroups（容器）中的数据。
- [`atomic top`和`docker top`](http://bit.ly/2Dxz3kd): 分别由Red Hat和Docker提供的实用程序，用来检查容器中运行的进程

## 附录

#### 常见概念

- `PV`(访问量)即`Page View`，中文翻译为页面浏览，即页面浏览量或单击量，不管客户端是不是相同，也不管`IP`是不是相同，用户只要访问网站页面就会被计算`PV`，一次计一个`PV`。
- `UV`(独立访客)即`Unique Visitor`，同一个客户端(PC或移动端)访问网站被计为一个访客。一天`(00:00-24:00)`内相同的客户端访问同一个网站只计一次`UV`。`UV`一般是以客户端`Cookie`等技术作为统计依据的，实际统计会有误差。
- `DAU`即`Daily Active User`，日活跃用户数量
- `MAU`即`Monthly Active Users`，月活跃用户数量
- `B2C`: 企业对消费者
- `B2B`: 企业对企业
- `回头率`: `回头客人/店铺总访客数`
- `转换率`: `客户数/UV`
- `点击率`: `点击数/页面展现`
- `PV利用率`: `客户数/PV`
- `客户月增长率`: `当月客户数/上月客户数 - 1`
- `客单价`: `支付宝成交金额/支付宝成交笔数`
- `页面打开率`: `从首页点击进入宝贝页的次数/首页浏览量`
- `人均访问页面数`: `PV/UV(浏览人数/页面总访问人数)`
- `DDoS`: 分布式拒绝服务攻击
- `可靠性`: 系统在特定时间特定条件下无故障实现指定功能的能力
- `康威定律`: 组织形式等同系统设计
- `单体架构`: 功能的综合体，把所有的业务逻辑放在一套代码实现
- `微服务架构`: 一种松耦合的能够被独立开发和部署的无状态化服务（独立扩展、升级和可替换）